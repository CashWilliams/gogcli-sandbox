name: release

on:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - goos: linux
            goarch: amd64
          - goos: linux
            goarch: arm64
          - goos: darwin
            goarch: amd64
          - goos: darwin
            goarch: arm64
          - goos: windows
            goarch: amd64
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22"
          cache: true
      - name: Build
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          CGO_ENABLED: "0"
        run: |
          mkdir -p dist
          ext=""
          if [ "$GOOS" = "windows" ]; then
            ext=".exe"
          fi
          go build -o "dist/gogcli-sandbox${ext}" ./cmd/broker
          go build -o "dist/gogcli-sandbox-client${ext}" ./cmd/client
          go build -o "dist/gogcli-sandbox-init${ext}" ./cmd/bootstrap
      - name: Package (tar.gz)
        if: matrix.goos != 'windows'
        run: |
          version="${{ github.ref_name }}"
          archive="gogcli-sandbox_${version}_${{ matrix.goos }}_${{ matrix.goarch }}.tar.gz"
          tar -czf "$archive" -C dist .
      - name: Package (zip)
        if: matrix.goos == 'windows'
        run: |
          version="${{ github.ref_name }}"
          archive="gogcli-sandbox_${version}_${{ matrix.goos }}_${{ matrix.goarch }}.zip"
          (cd dist && zip -r "../$archive" .)
      - name: Upload release assets
        uses: softprops/action-gh-release@v2
        with:
          files: |
            gogcli-sandbox_${{ github.ref_name }}_${{ matrix.goos }}_${{ matrix.goarch }}.*

  update-tap:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout tap repo
        uses: actions/checkout@v4
        with:
          repository: CashWilliams/homebrew-tap
          token: ${{ secrets.TAP_GH_TOKEN }}
          path: tap
      - name: Download release assets
        env:
          GH_TOKEN: ${{ secrets.TAP_GH_TOKEN }}
        run: |
          tag="${{ github.event.release.tag_name }}"
          gh release download "$tag" -R "${{ github.repository }}" \
            -p "gogcli-sandbox_${tag}_*.tar.gz"
      - name: Update formula
        run: |
          tag="${{ github.event.release.tag_name }}"
          version="${tag#v}"

          export VERSION="${version}"
          export SHA_DARWIN_ARM64="$(shasum -a 256 gogcli-sandbox_${tag}_darwin_arm64.tar.gz | awk '{print $1}')"
          export SHA_DARWIN_AMD64="$(shasum -a 256 gogcli-sandbox_${tag}_darwin_amd64.tar.gz | awk '{print $1}')"
          export SHA_LINUX_ARM64="$(shasum -a 256 gogcli-sandbox_${tag}_linux_arm64.tar.gz | awk '{print $1}')"
          export SHA_LINUX_AMD64="$(shasum -a 256 gogcli-sandbox_${tag}_linux_amd64.tar.gz | awk '{print $1}')"

          python - <<'PY'
          import os
          import pathlib

          version = os.environ["VERSION"]
          sha = {
              "darwin_arm64": os.environ["SHA_DARWIN_ARM64"],
              "darwin_amd64": os.environ["SHA_DARWIN_AMD64"],
              "linux_arm64": os.environ["SHA_LINUX_ARM64"],
              "linux_amd64": os.environ["SHA_LINUX_AMD64"],
          }

          path = pathlib.Path("tap/Formula/gogcli-sandbox.rb")
          lines = path.read_text().splitlines()
          out = []
          version_updated = False
          sha_updated = set()
          pending = None

          for line in lines:
              stripped = line.strip()
              if stripped.startswith("version "):
                  prefix = line.split("version", 1)[0]
                  line = f'{prefix}version "{version}"'
                  version_updated = True
              if "darwin_arm64.tar.gz" in line:
                  pending = "darwin_arm64"
              elif "darwin_amd64.tar.gz" in line:
                  pending = "darwin_amd64"
              elif "linux_arm64.tar.gz" in line:
                  pending = "linux_arm64"
              elif "linux_amd64.tar.gz" in line:
                  pending = "linux_amd64"
              elif stripped.startswith("sha256 ") and pending:
                  prefix = line.split("sha256", 1)[0]
                  line = f'{prefix}sha256 "{sha[pending]}"'
                  sha_updated.add(pending)
                  pending = None
              out.append(line)

          if not version_updated:
              raise SystemExit("failed to update version in formula")
          missing = {k for k in sha.keys() if k not in sha_updated}
          if missing:
              raise SystemExit(f"failed to update sha256 for: {', '.join(sorted(missing))}")

          path.write_text("\n".join(out) + "\n")
          PY
      - name: Show tap diff
        run: |
          git -C tap status --porcelain
          git -C tap --no-pager diff -- Formula/gogcli-sandbox.rb
      - name: Commit and push
        run: |
          cd tap
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/gogcli-sandbox.rb
          git commit -m "gogcli-sandbox ${{ github.event.release.tag_name }}" || exit 0
          git push
